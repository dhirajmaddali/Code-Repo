<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SimpliFI Rate Calculator</title>
  <style>
    /* System font stack; no remote fonts for MV3 CSP */
    :root {
      --background-color: #f7f9fc;
      --card-background-color: #ffffff;
      --text-color: #3c4043;
      --header-color: #5f6368;
      --input-border-color: #dadce0;
      --input-focus-border-color: #1a73e8;
      --primary-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      --label-color: #5f6368;
      --positive-gp-color: #1e8e3e;
      --negative-gp-color: #d93025;
      --border-radius: 8px;
      --divider-color: #e0e0e0;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--primary-font); background: var(--background-color); color: var(--text-color); padding: 16px; min-width: 800px; }

    .container { width: 100%; max-width: 1300px; margin: 0 auto; background: var(--card-background-color); border-radius: var(--border-radius); padding: 16px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.08); }

    .header { display: flex; justify-content: space-between; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--divider-color); }
    .header h1 { font-size: 20px; font-weight: 600; color: #1a73e8; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .client-selector { display: flex; gap: 8px; align-items: center; }
    .client-selector label { font-size: 14px; font-weight: 500; }
    .client-selector select { padding: 6px 10px; border: 1px solid var(--input-border-color); border-radius: 6px; background-color: #fff; font-size: 14px; }
    .fee-display { background:#e8f0fe; color: #1967d2; padding:6px 10px; border-radius:6px; font-size: 13px; font-weight: 500; }

    .reset-button { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--input-border-color); background: #fff; color: var(--header-color); cursor: pointer; font-size: 16px; transition: background-color 0.2s, transform 0.2s; }
    .reset-button:hover { background-color: #f1f3f4; transform: rotate(90deg); }

    .main-content { display: flex; gap: 24px; }
    .calculator-container { flex: 2; }
    .report-container { flex: 3; background: #f8f9fa; padding: 16px; border-radius: 8px; border: 1px solid var(--divider-color); }

    .calculator-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 8px 12px; align-items: center; }
    .grid-header { font-weight: 700; text-align: right; padding-bottom: 6px; color: var(--header-color); font-size: 14px; }
    .grid-label { font-weight: 500; text-align: left; font-size: 14px; }
    .grid-cell, .grid-label { display: flex; align-items: center; justify-content: flex-start; }
    .input-cell { width: 100%; padding: 8px; border: 1px solid var(--input-border-color); border-radius: 6px; text-align: right; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; }
    .input-cell:focus { outline: none; border-color: var(--input-focus-border-color); box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2); }
    .display-cell { font-size: 14px; padding: 8px; text-align: right; width: 100%; background-color: #f8f9fa; border-radius: 6px; font-weight: 500; }

    .section-title { grid-column: 1/-1; font-size: 16px; font-weight: 600; margin: 12px 0 6px; border-bottom: 1px solid var(--divider-color); padding-bottom: 6px; color: #1a73e8; }

    .report-section { margin-bottom: 20px; }
    .report-section:last-child { margin-bottom: 0; }
    .report-section-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--divider-color); color: var(--header-color); }
    .report-subsection-title { font-size: 14px; font-weight: 600; margin: 12px 0 8px; color: #5f6368;}

    .nurse-package-grid { display: grid; grid-template-columns: 1.5fr repeat(4,1fr); gap: 8px 12px; font-size: 14px; }
    .nurse-package-grid > div { text-align: right; padding: 4px; }
    .nurse-package-header { font-weight: 700; color: var(--label-color); text-decoration: underline; }
    .nurse-package-label { font-weight: 600; text-align: left; }
    .total-row { font-weight: 700; border-top: 1px solid var(--divider-color); padding-top: 8px; margin-top: 4px; }

    .report-bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .report-kv-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; align-items: center; font-size: 14px; }
    .report-kv-key { color: var(--label-color); text-align: left; }
    .report-kv-value { font-weight: 600; text-align: right; background-color: #f1f3f4; padding: 4px 8px; border-radius: 4px; }

    .sick-pay-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .auto-calc-label {
      font-weight: normal;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: var(--label-color);
    }

    .checkbox-cell {
      justify-content: flex-end;
      padding-right: 8px;
    }


    /* Gauge */
    .margin-analysis-container { display: flex; flex-direction: column; }
    .margin-analysis-core { display: flex; align-items: center; gap: 20px; }
    .margin-gauge { position: relative; width: 160px; height: 85px; overflow: hidden; }
    .margin-gauge-svg { position: absolute; top: 0; left: 0; }
    .gauge-background { fill: none; stroke: #e9ecef; stroke-dasharray: 188.5; stroke-dashoffset: 0; }
    .gauge-progress { fill: none; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease-out, stroke 0.5s; }

    .margin-gauge-content { position: absolute; bottom: 0; left: 0; right: 0; text-align:center; }
    .margin-gauge-value { font-size: 26px; font-weight: 700; }
    .margin-gauge-label { font-size: 11px; color: var(--label-color); text-transform: uppercase; display: block; }

    .margin-analysis-message { font-weight: 500; font-size: 15px; flex-grow: 1; }
    .margin-analysis-suggestions { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; margin-top: 16px; }
    .suggestion-card { border: 1px solid var(--input-border-color); background: #fff; border-radius: 8px; padding: 12px; }
    .suggestion-card h5 { margin-bottom: 8px; font-size: 14px; color: var(--header-color); }
    .suggestion-values { display: flex; flex-direction: column; gap: 6px; }
    .suggestion-values > div { display: flex; justify-content: space-between; align-items: center; }
    .suggestion-label { color: var(--label-color); font-size: 12px; }
    .suggestion-value { font-weight: 600; font-size: 13px; }

    @media (max-width: 1100px) {
      .main-content { flex-direction: column; }
    }

    @media (max-width: 900px) {
      body { min-width: 100%; padding: 8px; }
      .report-bottom-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 id="title">Rate Calculator</h1>
      <div class="header-actions">
        <div class="client-selector">
          <label for="client">Client:</label>
          <select id="client"></select>
          <div id="fee" class="fee-display">Fee: —</div>
        </div>
        <button id="reset" class="reset-button" title="Reset">↻</button>
      </div>
    </header>

    <main class="main-content">
      <section class="calculator-container">
        <div class="calculator-grid">
          <div class="grid-label"></div>
          <div class="grid-header">Regular</div>
          <div class="grid-header">OT</div>

          <h2 class="section-title">Billing to client</h2>
          <div class="grid-label">Bill Rate</div>
          <input class="input-cell" type="number" id="bill_regular" placeholder="0.00">
          <input class="input-cell" type="number" id="bill_ot" placeholder="0.00">

          <div class="grid-label">Rate After Fee</div>
          <div class="display-cell" id="afterfee_regular">$0.00</div>
          <div class="display-cell" id="afterfee_ot">$0.00</div>

          <h2 class="section-title">Pay to Candidate</h2>
          <div class="grid-label">W2 Pay Rate</div>
          <input class="input-cell" type="number" id="pay_regular" placeholder="0.00">
          <input class="input-cell" type="number" id="pay_ot" placeholder="0.00">

          <h2 class="section-title">Hours</h2>
          <div class="grid-label">Weekly Hours</div>
          <input class="input-cell" type="number" id="hrs_regular" placeholder="0">
          <input class="input-cell" type="number" id="hrs_ot" placeholder="0">

          <div class="grid-label">Contract Length (weeks)</div>
          <input class="input-cell" type="number" id="contract_len" placeholder="0">
          <div class="grid-cell"></div>

          <div class="grid-label">Total OT Hours (Weekly)</div>
          <div class="display-cell" id="total_ot_hours_weekly">0</div>
          <div class="grid-cell"></div>

          <div class="grid-label">Schedule days in a week</div>
          <input class="input-cell" type="number" id="schedule_days" placeholder="5">
          <div class="grid-cell"></div>

          <h2 class="section-title">General</h2>
          <div class="grid-label">Housing Allowance (Daily)</div>
          <input class="input-cell" type="number" id="house_daily" placeholder="0.00">
          <div class="grid-cell"></div>

          <div class="grid-label">Meals & Incidentals (Daily)</div>
          <input class="input-cell" type="number" id="meals_daily" placeholder="0.00">
          <div class="grid-cell"></div>

          <h2 class="section-title">Orientation</h2>
          <div class="grid-label">Orientation Type</div>
          <select class="input-cell" id="orient_type">
            <option>Billable</option>
            <option>Non Billable</option>
          </select>
          <div class="grid-cell"></div>

          <div class="grid-label">Hours per contract</div>
          <input class="input-cell" type="number" id="orient_hours" placeholder="0">
          <div class="grid-cell"></div>

          <div class="grid-label">Non-Billable Pay Rate Per Hour</div>
          <input class="input-cell" type="number" id="orient_pay" placeholder="0.00">
          <div class="grid-cell"></div>

          <div class="grid-label">Total Orientation Pay</div>
          <div class="display-cell" id="orient_total">$0.00</div>
          <div class="grid-cell"></div>

          <h2 class="section-title">Additional Pay</h2>
          <div class="grid-label">Assignment Start Bonus</div>
          <input class="input-cell" type="number" id="bonus_start" placeholder="0.00">
          <div class="display-cell" id="hourly_start">$0.00</div>

          <div class="grid-label">Assignment Completion Bonus</div>
          <input class="input-cell" type="number" id="bonus_complete" placeholder="0.00">
          <div class="display-cell" id="hourly_complete">$0.00</div>

          <div class="grid-label">BCG Reimbursement</div>
          <input class="input-cell" type="number" id="bcg_reimb" placeholder="0.00">
          <div class="display-cell" id="hourly_bcg">$0.00</div>

          <div class="grid-label sick-pay-label">
            Sick Pay Hours
            <label class="auto-calc-label" for="auto_sick_calc" title="Automatically calculate sick pay hours based on contract length">
              Auto
              <input type="checkbox" id="auto_sick_calc">
            </label>
          </div>
          <input class="input-cell" type="number" id="sick_hours" placeholder="0">
          <div class="display-cell" id="hourly_sick">$0.00</div>
        </div>
      </section>

      <section class="report-container">
        <section class="report-section">
          <h3 class="report-section-title">NURSE PACKAGE</h3>
          <div class="nurse-package-grid">
            <div></div>
            <div class="nurse-package-header">Hourly</div>
            <div class="nurse-package-header">Daily</div>
            <div class="nurse-package-header">Weekly</div>
            <div class="nurse-package-header">Monthly</div>

            <div class="nurse-package-label">W-2 Taxable</div>
            <div id="np_tax_hourly">No data</div>
            <div id="np_tax_daily">No data</div>
            <div id="np_tax_weekly">No data</div>
            <div id="np_tax_monthly">No data</div>

            <div class="nurse-package-label">Non-Taxable Travel</div>
            <div id="np_nt_hourly">No data</div>
            <div id="np_nt_daily">No data</div>
            <div id="np_nt_weekly">No data</div>
            <div id="np_nt_monthly">No data</div>

            <div class="nurse-package-label total-row">Total</div>
            <div class="total-row" id="np_total_hourly">No data</div>
            <div class="total-row" id="np_total_daily">No data</div>
            <div class="total-row" id="np_total_weekly">No data</div>
            <div class="total-row" id="np_total_monthly">No data</div>
          </div>
        </section>

        <div class="report-bottom-grid">
          <section class="report-section">
            <h3 class="report-section-title">GROSS MARGINS</h3>
            <div class="report-kv-grid">
              <div class="report-kv-key">Hourly Margin</div><div class="report-kv-value" id="gm_hourly">No data</div>
              <div class="report-kv-key">OT Hourly Margin</div><div class="report-kv-value" id="gm_ot_hourly">No data</div>
              <div class="report-kv-key">Weekly Net</div><div class="report-kv-value" id="gm_weekly">No data</div>
              <div class="report-kv-key">Monthly Net</div><div class="report-kv-value" id="gm_monthly">No data</div>
              <div class="report-kv-key">Contract Net</div><div class="report-kv-value" id="gm_contract">No data</div>
              <div class="report-kv-key">Weekly billing to client</div><div class="report-kv-value" id="bill_weekly">No data</div>
              <div class="report-kv-key">Monthly billing to client</div><div class="report-kv-value" id="bill_monthly">No data</div>
              <div class="report-kv-key">Total contract billing to client</div><div class="report-kv-value" id="bill_contract">No data</div>
            </div>
          </section>

          <section class="report-section">
            <h3 class="report-section-title">PACKAGE OFFERED TO NURSE</h3>
            <h4 class="report-subsection-title">Hourly Breakdown</h4>
            <div class="report-kv-grid">
              <div class="report-kv-key">Total Hourly Pay Rate</div><div class="report-kv-value" id="pkg_total_hourly">No data</div>
              <div class="report-kv-key">On W2(Taxable)</div><div class="report-kv-value" id="pkg_w2">No data</div>
              <div class="report-kv-key">On W2(Taxable) OT</div><div class="report-kv-value" id="pkg_w2_ot">No data</div>
              <div class="report-kv-key">Stipend(Non-Taxable)</div><div class="report-kv-value" id="pkg_stipend_hourly">No data</div>
              <div class="report-kv-key">Special OT Rate if Standard hours between 40 to 48</div><div class="report-kv-value" id="pkg_ot_special">No data</div>
            </div> &nbsp;

            <h4 class="report-subsection-title">Weekly Breakdown</h4>
            <div class="report-kv-grid">
              <div class="report-kv-key">Weekly Gross</div><div class="report-kv-value" id="pkg_weekly_gross">No data</div>
              <div class="report-kv-key">On W2(Taxable)</div><div class="report-kv-value" id="pkg_weekly_w2">No data</div>
              <div class="report-kv-key">Total Stipend (Non-Taxable)</div><div class="report-kv-value" id="pkg_weekly_stipend">No data</div>
            </div>
          </section>
        </div>

        <section class="report-section margin-analysis-container">
          <h3 class="report-section-title">Hourly Margin Analysis</h3>
          <div class="margin-analysis-core">
            <div class="margin-gauge" aria-hidden="true">
              <svg width="160" height="160" viewBox="0 0 160 160" class="margin-gauge-svg">
                <circle class="gauge-background" cx="80" cy="80" r="60" stroke-width="20"></circle>
                <circle id="gaugeArc" class="gauge-progress" cx="80" cy="80" r="60" stroke-width="20"
                        transform="rotate(-90 80 80)" />
              </svg>
              <div class="margin-gauge-content">
                <span class="margin-gauge-value" id="gaugeValue">$0.00</span>
                <span class="margin-gauge-label">Effective Hourly Margin</span>
              </div>
            </div>
            <p id="ma_message" class="margin-analysis-message">Enter numbers to analyze margin.</p>
          </div>
          <div class="margin-analysis-suggestions" id="ma_suggestions"></div>
        </section>
      </section>
    </main>
  </div>

  <script type="module">
    // popup.js — Looker Studio parity + UX automations (2025-08-21)
    // Matches the provided formulas/screenshots and wires automatic updates.
    //
    // Key behaviors
    // - Orientation Type dropdown: Billable / Non Billable (default Non Billable @ 16.5/hr)
    // - Sick Pay Hours auto-fills from Hours section: (Weekly Hours * Contract Weeks) / 30
    // - When Pay to Candidate (W-2 hourly) changes, auto-sets OT (1.5x) and recomputes
    // - Additional Pay hourlies auto-calc from one-time inputs and W-2/sick hours
    // - GROSS MARGINS and WEEKLY BREAKDOWN match Looker Studio logic
    //
    // Expected element IDs in HTML (inputs):
    //   client, bill_regular, bill_ot, pay_regular, pay_ot, hrs_regular, hrs_ot, contract_len,
    //   house_daily, meals_daily, orient_type, orient_hours, orient_pay,
    //   bonus_start, bonus_complete, bcg_reimb, sick_hours, schedule_days, auto_sick_calc
    // Expected element IDs in HTML (outputs/text placeholders):
    //   afterfee_regular, afterfee_ot,
    //   np_tax_hourly, np_tax_daily, np_tax_weekly, np_tax_monthly,
    //   np_nt_hourly, np_nt_daily, np_nt_weekly, np_nt_monthly,
    //   np_total_hourly, np_total_daily, np_total_weekly, np_total_monthly,
    //   gm_hourly, gm_ot_hourly, gm_weekly, gm_monthly, gm_contract,
    //   bill_weekly, bill_monthly, bill_contract,
    //   pkg_total_hourly, pkg_w2, pkg_w2_ot, pkg_stipend_hourly, pkg_ot_special,
    //   pkg_weekly_gross, pkg_weekly_w2, pkg_weekly_stipend,
    //   orient_total, orient_hourly,
    //   hourly_start, hourly_complete, hourly_bcg, hourly_sick,
    //   total_ot_hours_weekly,
    //   gaugeArc, gaugeValue, title, fee, reset
    //
    // NOTE: If some IDs are missing in HTML, those specific outputs will be skipped gracefully.

    const CLIENT_FEES = {
      "SimpliFI": 0.06,
      "Careerstaff": 0.06,
      "Medical Solutions": 0.05,
      "AMN": 0.0625,
      "HWL": 0.05,
      "Eisenhower Health": 0.05,
      "Focus One": 0.05,
      "Priority Group": 0.085,
      "Intermountain Health": 0.035,
      "AYA": 0.03,
      "NYCHH": 0.07,
      "Medefis": 0.0625
    };

    const BURDEN = 1.23;           // Employer burden multiplier for W-2 and specified items
    const WEEKS_IN_MONTH = 4;      // Per Looker Studio
    const DEFAULT_SCHEDULE_DAYS = 5;

    const el = (id) => document.getElementById(id);
    const fmtUSD = (v) =>
      (isFinite(v) ? v : 0).toLocaleString("en-US", { style: "currency", currency: "USD" });

    function valNum(id, fallback = 0) {
      const n = el(id);
      if (!n) return fallback;
      const v = parseFloat(n.value);
      return isFinite(v) ? v : fallback;
    }
    function setText(id, text) { const n = el(id); if (n) n.textContent = text; }
    function setValue(id, value) {
      const n = el(id);
      if (n) n.value = String(value);
    }

    function ensureClientSelector() {
      const clientSel = el("client");
      if (!clientSel) return;
      if (clientSel.options.length === 0) {
        Object.keys(CLIENT_FEES).forEach(c => {
          const o = document.createElement("option"); o.value = c; o.textContent = c; clientSel.appendChild(o);
        });
      }
      if (!clientSel.value) clientSel.value = "SimpliFI";
      const feeTxt = el("fee");
      if (feeTxt) feeTxt.textContent = "Fee: " + (CLIENT_FEES[clientSel.value]).toLocaleString("en-US", {style:"percent", minimumFractionDigits:2});
      const ttl = el("title"); if (ttl) ttl.textContent = clientSel.value + " Rate Calculator";
      clientSel.addEventListener("change", () => {
        if (feeTxt) feeTxt.textContent = "Fee: " + (CLIENT_FEES[clientSel.value]).toLocaleString("en-US", {style:"percent", minimumFractionDigits:2});
        if (ttl) ttl.textContent = clientSel.value + " Rate Calculator";
        recalc();
      });
    }

    function ensureOrientationControls() {
      const orientSel = el("orient_type");
      if (!orientSel) return;
      if (orientSel.options.length === 0) {
        ["Billable","Non Billable"].forEach(v => {
          const o = document.createElement("option"); o.value = o.textContent = v; orientSel.appendChild(o);
        });
      }
      orientSel.value = "Non Billable"; // Set default value
      const orientPay = el("orient_pay");
      if (orientSel.value === "Non Billable" && orientPay && (!orientPay.value || parseFloat(orientPay.value) === 0)) {
        orientPay.value = "16.5";
      }
      orientSel.addEventListener("change", () => {
        const orientPayInput = el("orient_pay");
        if (orientSel.value === "Non Billable" && orientPayInput) {
            orientPayInput.value = "16.5";
        }
        recalc();
      });
    }

    function ensureReset() {
      const resetBtn = el("reset");
      if (!resetBtn) return;
      resetBtn.addEventListener("click", () => {
        document.querySelectorAll("input[type=number]").forEach(i => {
          i.value = '';
        });
        document.querySelectorAll("input[type=checkbox]").forEach(i => {
          i.checked = false;
        });
        const clientSel = el("client"); if (clientSel) clientSel.value = "SimpliFI";
        const orientSel = el("orient_type"); if (orientSel) orientSel.value = "Non Billable";
        const orientPay = el("orient_pay"); if (orientPay) orientPay.value = "16.5";
        const scheduleDays = el("schedule_days"); if(scheduleDays) scheduleDays.value = "5";
        const sickBox = el("auto_sick_calc"); if (sickBox) sickBox.checked = true;
        recalc();
      });
    }

    function wireAutoSick() {
      const sickBox = el("auto_sick_calc");
      if (sickBox) {
        if (typeof sickBox.checked === "boolean" && sickBox.checked === false) {
          // leave as-is; user can toggle
        } else {
          sickBox.checked = true;
        }
        sickBox.addEventListener("change", recalc);
      }
    }

    function wirePayToCandidate() {
      const w2 = el("pay_regular");
      if (!w2) return;
      const ot = el("pay_ot");
      const sync = () => { if (ot) {
          const w2Value = parseFloat(w2.value || "0");
          ot.value = w2Value > 0 ? (w2Value * 1.5 || 0).toFixed(2) : '';
        }
      };
      w2.addEventListener("input", () => { sync(); recalc(); });
      // initialize once
      sync();
    }

    function init() {
      ensureClientSelector();
      ensureOrientationControls();
      ensureReset();
      wireAutoSick();
      wirePayToCandidate();

      // Recalc on any input/select change
      document.querySelectorAll("input, select").forEach(i => i.addEventListener("input", recalc));
      recalc();
    }

    function recalc() {
      const client = el("client")?.value || "SimpliFI";
      const fee = CLIENT_FEES[client] || 0;

      // INPUTS
      const billR = valNum("bill_regular", 0);      // Bill Rate
      const billOT = valNum("bill_ot", 0);          // Over Time Addition
      const payR = valNum("pay_regular", 0);        // W-2 hourly
      const payOT = valNum("pay_ot", 0);
      const weeks = valNum("contract_len", 0);      // Contract duration in weeks
      
      // OT Hours Logic
      const hrsR_input = valNum("hrs_regular", 0);  // Standard hours/week from input
      const ot_from_regular = hrsR_input > 40 ? hrsR_input - 40 : 0;
      const hrsR = hrsR_input > 40 ? 40 : hrsR_input; // Effective regular hours capped at 40
      const hrsOT_manual = valNum("hrs_ot", 0);
      const hrsOT = ot_from_regular + hrsOT_manual; // Weekly OT is hours over 40 + any manual OT

      const houseDaily = valNum("house_daily", 0);  // Housing Allowance Daily
      const mealsDaily = valNum("meals_daily", 0);  // Meals & Incidentals Daily
      const orientType = el("orient_type")?.value || "Non Billable";
      const orientHours = valNum("orient_hours", 0);
      const orientPay = valNum("orient_pay", 0);
      const bonusStart = valNum("bonus_start", 0);
      const bonusComplete = valNum("bonus_complete", 0);
      const bcgReimb = valNum("bcg_reimb", 0);
      const scheduleDays = valNum("schedule_days", DEFAULT_SCHEDULE_DAYS);

      // ---- Derived base values (Looker Studio mapping) ----

      // Rate after fee
      const hrAfterFee = billR * (1 - fee);
      const otHrAfterFee = (billR + billOT) * (1 - fee);

      // Contract hours (based on weekly input)
      const totalRegularHoursForContract = hrsR * weeks;
      const totalContractHoursInput = hrsR_input * weeks;
      setText("total_ot_hours_weekly", hrsOT > 0 ? hrsOT.toFixed(1) : "0");
      
      // Hourly stipend for NURSE PACKAGE (based on schedule days)
      const ND = houseDaily + mealsDaily;       // daily non-tax
      const NW = ND * scheduleDays;             // weekly non-tax total
      const baseStipendHourly = hrsR > 0 ? (NW / hrsR) : 0; // Stipend hourly
      const NH = baseStipendHourly; // This is the Non-Taxable Hourly for the package display

      // "Actual" hourly stipend cost for MARGIN CALCULATION (based on 7 days)
      const actualNonTaxableStipendHourly = hrsR > 0 ? ((houseDaily + mealsDaily) * 7 / hrsR) : 0;

      // Sick Pay Logic
      const autoSickCalc = el("auto_sick_calc")?.checked;
      let sickHours = valNum("sick_hours", 0);
      if (autoSickCalc) {
        sickHours = (hrsR_input * weeks) / 30;
        setValue("sick_hours", sickHours > 0 ? sickHours.toFixed(2) : '');
      }

      // ---- COST COMPONENTS (Burdened Hourly Rates) ----

      // Cost Component: Orientation Pay
      const totalOrientationPay = orientHours * orientPay;
      
      // Cost Component: Orientation (hourly)
      const orientationBurdenedHourly = (orientType === "Non Billable" && totalContractHoursInput > 0)
        ? (totalOrientationPay / totalContractHoursInput) * BURDEN
        : 0;

      // Cost Component: Additional Pay (Bonuses, etc.)
      const bonusStartHourly = (bonusStart > 0 && totalContractHoursInput > 0) ? (bonusStart / totalContractHoursInput) : 0;
      const bonusCompleteHourly = (bonusComplete > 0 && totalContractHoursInput > 0) ? (bonusComplete / totalContractHoursInput) : 0;
      // All BCG reimbursement is now treated as taxable.
      const taxableBcgHourly = (bcgReimb > 0 && totalContractHoursInput > 0) ? (bcgReimb / totalContractHoursInput) : 0;
      const additionalPayHourlyCost = (bonusStartHourly + bonusCompleteHourly + taxableBcgHourly) * BURDEN;
      
      // Cost Component: Sick Pay
      const sickPayBurdenedHourly = (sickHours > 0 && totalContractHoursInput > 0)
        ? (payR * sickHours / totalContractHoursInput) * BURDEN
        : 0;
      
      // Cost Component: W-2 Pay (Regular and OT)
      const totalW2BurdenedHourly = payR * BURDEN;
      const totalW2BurdenedOT = payOT * BURDEN;

      // Total Hourly Cost (sum of all cost components)
      const totalHourlyCost = actualNonTaxableStipendHourly + totalW2BurdenedHourly + sickPayBurdenedHourly + additionalPayHourlyCost + orientationBurdenedHourly;

      // ---- MARGIN CALCULATIONS ----
      const hourlyMargin = hrAfterFee - totalHourlyCost;
      
      const otMarginPart1 = otHrAfterFee - totalW2BurdenedOT;
      const otMarginPart2 = (hrsOT > 0) ? (hrAfterFee - totalW2BurdenedOT - NH) : 0;
      const otHourlyMargin = otMarginPart1 + otMarginPart2;
      
      const weeklyMargin = hourlyMargin * hrsR_input;
      const monthlyMargin = weeklyMargin * WEEKS_IN_MONTH;
      const contractMargin = weeklyMargin * weeks;

      // ---- BILLING CALCULATIONS ----
      const weeklyBilling = (hrAfterFee * hrsR_input) + (otHrAfterFee * hrsOT_manual);
      const monthlyBilling = weeklyBilling * WEEKS_IN_MONTH;
      const contractBilling = weeklyBilling * weeks;

      // ---- NURSE PACKAGE ----
      const np_tax_hourly = payR;
      const np_tax_weekly = payR * hrsR_input;
      const np_tax_daily = scheduleDays > 0 ? np_tax_hourly * (hrsR_input / scheduleDays) : 0;
      const np_tax_monthly = np_tax_weekly * WEEKS_IN_MONTH;
      const np_nt_hourly = NH;
      const np_nt_daily = ND;
      const np_nt_weekly = np_nt_daily * scheduleDays;
      const np_nt_monthly = np_nt_weekly * WEEKS_IN_MONTH;
      const np_total_hourly = np_tax_hourly + np_nt_hourly;
      const np_total_daily = np_tax_daily + np_nt_daily;
      const np_total_weekly = np_tax_weekly + np_nt_weekly;
      const np_total_monthly = np_tax_monthly + np_nt_monthly;

      // ---- PACKAGE OFFERED TO NURSE ----
      const pkg_total_hourly = np_total_hourly;
      const pkg_w2 = payR;
      const pkg_w2_ot = payOT;
      const pkg_stipend_hourly = NH;
      const pkg_ot_special = (hrsR_input > 40 && hrsR_input <= 48) ? (payOT + NH) : 0;

      const pkg_weekly_w2 = (hrsR_input > 40)
        ? ((payR * hrsR_input) + ((hrsR_input - 40) * (payOT + NH)))
        : (payR * hrsR_input);
      const pkg_weekly_stipend = hrsR_input * NH;
      const pkg_weekly_gross = pkg_weekly_w2 + pkg_weekly_stipend;

      // ---- UI UPDATES ----
      setText("afterfee_regular", fmtUSD(hrAfterFee));
      setText("afterfee_ot", fmtUSD(otHrAfterFee));
      setText("np_tax_hourly", fmtUSD(np_tax_hourly));
      setText("np_tax_daily", fmtUSD(np_tax_daily));
      setText("np_tax_weekly", fmtUSD(np_tax_weekly));
      setText("np_tax_monthly", fmtUSD(np_tax_monthly));
      setText("np_nt_hourly", fmtUSD(np_nt_hourly));
      setText("np_nt_daily", fmtUSD(np_nt_daily));
      setText("np_nt_weekly", fmtUSD(np_nt_weekly));
      setText("np_nt_monthly", fmtUSD(np_nt_monthly));
      setText("np_total_hourly", fmtUSD(np_total_hourly));
      setText("np_total_daily", fmtUSD(np_total_daily));
      setText("np_total_weekly", fmtUSD(np_total_weekly));
      setText("np_total_monthly", fmtUSD(np_total_monthly));
      setText("gm_hourly", fmtUSD(hourlyMargin));
      setText("gm_ot_hourly", fmtUSD(otHourlyMargin));
      setText("gm_weekly", fmtUSD(weeklyMargin));
      setText("gm_monthly", fmtUSD(monthlyMargin));
      setText("gm_contract", fmtUSD(contractMargin));
      setText("bill_weekly", fmtUSD(weeklyBilling));
      setText("bill_monthly", fmtUSD(monthlyBilling));
      setText("bill_contract", fmtUSD(contractBilling));
      setText("pkg_total_hourly", fmtUSD(pkg_total_hourly));
      setText("pkg_w2", fmtUSD(pkg_w2));
      setText("pkg_w2_ot", fmtUSD(pkg_w2_ot));
      setText("pkg_stipend_hourly", fmtUSD(pkg_stipend_hourly));
      setText("pkg_ot_special", fmtUSD(pkg_ot_special));
      setText("pkg_weekly_gross", fmtUSD(pkg_weekly_gross));
      setText("pkg_weekly_w2", fmtUSD(pkg_weekly_w2));
      setText("pkg_weekly_stipend", fmtUSD(pkg_weekly_stipend));
      setText("orient_total", fmtUSD(totalOrientationPay));
      setText("hourly_start", fmtUSD(bonusStartHourly * BURDEN));
      setText("hourly_complete", fmtUSD(bonusCompleteHourly * BURDEN));
      setText("hourly_bcg", fmtUSD(taxableBcgHourly * BURDEN));
      setText("hourly_sick", fmtUSD(sickPayBurdenedHourly));

      // ---- GAUGE AND MARGIN ANALYSIS ----
      const gaugeArc = el("gaugeArc");
      const gaugeValue = el("gaugeValue");
      const maMessage = el("ma_message");
      const maSuggestions = el("ma_suggestions");

      if (gaugeArc && gaugeValue && maMessage && maSuggestions) {
        const MAX_MARGIN_GOAL = 25;
        const percent = Math.max(0, (hourlyMargin / MAX_MARGIN_GOAL) * 100);
        const circumference = 2 * Math.PI * 60;
        const arcLength = circumference / 2;
        const offset = arcLength * (1 - percent / 100);

        gaugeArc.setAttribute("stroke-dasharray", `${arcLength}`);
        gaugeArc.setAttribute("stroke-dashoffset", `${offset}`);
        gaugeValue.textContent = fmtUSD(hourlyMargin);
        
        if (hourlyMargin < 5) {
          gaugeArc.setAttribute("stroke", "var(--negative-gp-color)");
          gaugeValue.style.color = "var(--negative-gp-color)";
          maMessage.textContent = "Margin is critically low. Immediate adjustments are necessary.";
        } else if (hourlyMargin < 12) {
          gaugeArc.setAttribute("stroke", "#f9ab00");
          gaugeValue.style.color = "#f9ab00";
          maMessage.textContent = "Margin is below target. Consider optimizing costs or bill rate.";
        } else {
          gaugeArc.setAttribute("stroke", "var(--positive-gp-color)");
          gaugeValue.style.color = "var(--positive-gp-color)";
          maMessage.textContent = "Margin looks healthy. This is a competitive package.";
        }
        
        maSuggestions.innerHTML = '';
        
        if (billR > 0 && hrsR > 0) {
          const createSuggestionCard = (title, data) => {
            const card = document.createElement('div');
            card.className = 'suggestion-card';

            const h5 = document.createElement('h5');
            h5.textContent = title;
            card.appendChild(h5);

            const valuesDiv = document.createElement('div');
            valuesDiv.className = 'suggestion-values';
            
            for (const key in data) {
              const row = document.createElement('div');
              const label = document.createElement('span');
              label.className = 'suggestion-label';
              label.textContent = key;
              const value = document.createElement('span');
              value.className = 'suggestion-value';
              value.textContent = data[key];
              row.appendChild(label);
              row.appendChild(value);
              valuesDiv.appendChild(row);
            }
            card.appendChild(valuesDiv);
            return card;
          };

          // Card 1: Cost Breakdown
          const costData = {
            "W2 Burdened Pay": fmtUSD(totalW2BurdenedHourly),
            "Stipend (Non-Tax)": fmtUSD(actualNonTaxableStipendHourly),
            "Addtl. Pay Burdened": fmtUSD(additionalPayHourlyCost),
            "Sick Pay Burdened": fmtUSD(sickPayBurdenedHourly),
            "Orientation Burdened": fmtUSD(orientationBurdenedHourly),
            "Total Hourly Cost": fmtUSD(totalHourlyCost)
          };
          maSuggestions.appendChild(createSuggestionCard("Hourly Cost Breakdown", costData));

          // Conditional Cards for low margin
          if (hourlyMargin < 12) {
            const TARGET_MARGIN = 15;
            
            // Card 2: Suggest new bill rate
            const neededBillRate = (TARGET_MARGIN + totalHourlyCost) / (1 - fee);
            const billData = {
              "Current Bill Rate": fmtUSD(billR),
              "Needed for $15 Margin": fmtUSD(neededBillRate)
            };
            maSuggestions.appendChild(createSuggestionCard("Bill Rate Adjustment", billData));

            // Card 3: Suggest new W2 pay
            const affordableW2 = (hrAfterFee - actualNonTaxableStipendHourly - additionalPayHourlyCost - sickPayBurdenedHourly - orientationBurdenedHourly - TARGET_MARGIN) / BURDEN;
            const w2Data = {
              "Current W2 Pay": fmtUSD(payR),
              "Affordable for $15 Margin": fmtUSD(affordableW2)
            };
            maSuggestions.appendChild(createSuggestionCard("W-2 Pay Adjustment", w2Data));
          }
        }
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
